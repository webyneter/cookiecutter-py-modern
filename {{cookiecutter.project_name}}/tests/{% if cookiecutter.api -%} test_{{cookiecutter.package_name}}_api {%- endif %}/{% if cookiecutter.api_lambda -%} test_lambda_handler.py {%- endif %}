"""Lambda handler tests."""

from typing import Any
from unittest.mock import MagicMock

import pytest

from {{cookiecutter.package_name}}_api.lambda_handler import handler


@pytest.fixture
def lambda_context() -> MagicMock:
    """Create a mock Lambda context."""
    context = MagicMock()
    context.function_name = "test-function"
    context.memory_limit_in_mb = 128
    context.invoked_function_arn = "arn:aws:lambda:us-east-1:123456789012:function:test"
    context.aws_request_id = "test-request-id-12345"
    return context


@pytest.fixture
def api_gateway_event() -> dict[str, Any]:
    """Create a sample API Gateway REST API v1 event.

    This event format is used by API Gateway REST APIs.
    See: https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-lambda.html
    """
    return {
        "resource": "/health",
        "path": "/health",
        "httpMethod": "GET",
        "headers": {
            "Host": "localhost",
            "Accept": "application/json",
            "X-Forwarded-For": "127.0.0.1",
            "X-Forwarded-Port": "443",
            "X-Forwarded-Proto": "https",
        },
        "multiValueHeaders": {
            "Host": ["localhost"],
            "Accept": ["application/json"],
        },
        "queryStringParameters": None,
        "multiValueQueryStringParameters": None,
        "pathParameters": None,
        "stageVariables": None,
        "requestContext": {
            "resourceId": "abc123",
            "resourcePath": "/health",
            "httpMethod": "GET",
            "extendedRequestId": "test-extended-request-id",
            "requestTime": "21/Dec/2024:12:00:00 +0000",
            "path": "/health",
            "accountId": "123456789012",
            "protocol": "HTTP/1.1",
            "stage": "test",
            "domainPrefix": "api",
            "requestTimeEpoch": 1703160000000,
            "requestId": "test-request-id",
            "identity": {
                "sourceIp": "127.0.0.1",
                "userAgent": "pytest",
            },
            "domainName": "api.example.com",
            "apiId": "abc123xyz",
        },
        "body": None,
        "isBase64Encoded": False,
    }


class TestLambdaHandler:
    """Lambda handler tests."""

    def test_handler_returns_successful_response(
        self,
        api_gateway_event: dict[str, Any],
        lambda_context: MagicMock,
    ) -> None:
        """Test handler returns a valid HTTP response."""
        response = handler(api_gateway_event, lambda_context)

        assert response["statusCode"] == 200
        assert "body" in response

    def test_handler_returns_json_content_type(
        self,
        api_gateway_event: dict[str, Any],
        lambda_context: MagicMock,
    ) -> None:
        """Test handler returns JSON content type."""
        response = handler(api_gateway_event, lambda_context)

        headers = response.get("headers", {})
        content_type = headers.get("content-type", "")
        assert "application/json" in content_type

    def test_handler_processes_health_endpoint(
        self,
        api_gateway_event: dict[str, Any],
        lambda_context: MagicMock,
    ) -> None:
        """Test handler correctly processes health endpoint."""
        response = handler(api_gateway_event, lambda_context)

        assert response["statusCode"] == 200
        assert "healthy" in response["body"]

    def test_handler_returns_404_for_unknown_path(
        self,
        api_gateway_event: dict[str, Any],
        lambda_context: MagicMock,
    ) -> None:
        """Test handler returns 404 for unknown paths."""
        api_gateway_event["path"] = "/unknown/endpoint"

        response = handler(api_gateway_event, lambda_context)

        assert response["statusCode"] == 404
