"""Authentication tests."""

import pytest
from fastapi.testclient import TestClient

from {{cookiecutter.package_name}}_api.auth.jwt import create_access_token, verify_token
from {{cookiecutter.package_name}}_api.auth.schemas import TokenData
from {{cookiecutter.package_name}}_api.exceptions import UnauthorizedError


class TestJWT:
    """JWT token tests."""

    def test_create_access_token(self) -> None:
        """Test creating an access token."""
        token = create_access_token(data={"sub": "testuser"})

        assert isinstance(token, str)
        assert len(token) > 0

    def test_verify_valid_token(self) -> None:
        """Test verifying a valid token."""
        token = create_access_token(data={"sub": "testuser"})
        token_data = verify_token(token)

        assert isinstance(token_data, TokenData)
        assert token_data.sub == "testuser"

    def test_verify_invalid_token(self) -> None:
        """Test verifying an invalid token raises error."""
        with pytest.raises(UnauthorizedError):
            verify_token("invalid-token")

    def test_verify_token_missing_subject(self) -> None:
        """Test token without subject raises error."""
        from datetime import UTC, datetime, timedelta

        from jose import jwt

        from {{cookiecutter.package_name}}_api.config import settings

        token = jwt.encode(
            {"exp": datetime.now(UTC) + timedelta(hours=1)},
            settings.jwt_secret_key,
            algorithm=settings.jwt_algorithm,
        )

        with pytest.raises(UnauthorizedError, match="missing subject"):
            verify_token(token)


class TestAuthEndpoint:
    """Authentication endpoint tests."""

    def test_login_success(self, client: TestClient) -> None:
        """Test successful login returns token."""
        response = client.post(
            "/auth/token",
            data={"username": "testuser", "password": "testpass"},
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert data["token_type"] == "bearer"

    def test_login_missing_credentials(self, client: TestClient) -> None:
        """Test login with missing credentials fails."""
        response = client.post(
            "/auth/token",
            data={"username": "", "password": ""},
        )

        # FastAPI returns 422 for validation errors (empty required fields)
        assert response.status_code == 422


class TestProtectedEndpoint:
    """Test authentication on protected endpoints."""

    def test_request_without_token(self, client: TestClient) -> None:
        """Test that requests without token to protected endpoints fail."""
        # This test is a placeholder for when you add protected endpoints
        # Example protected endpoint test:
        # response = client.get("/api/protected")
        # assert response.status_code == 401
        pass

    def test_request_with_valid_token(self, client: TestClient) -> None:
        """Test that requests with valid token succeed."""
        token = create_access_token(data={"sub": "testuser"})

        # This test is a placeholder for when you add protected endpoints
        # Example protected endpoint test:
        # response = client.get(
        #     "/api/protected",
        #     headers={"Authorization": f"Bearer {token}"},
        # )
        # assert response.status_code == 200
        assert token is not None
