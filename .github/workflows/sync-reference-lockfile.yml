# Sync Reference Lockfile Workflow
#
# Purpose: Syncs dependency updates from reference/requirements.txt back to the template's uv.lock.
# After a Dependabot PR is merged (updating requirements.txt), this workflow:
# 1. Generates the full variant
# 2. Applies the updated package versions from the merged PR
# 3. Copies the updated uv.lock to the template
# 4. Creates a PR with the changes
#
# Trigger: Push to main with changes to reference/requirements.txt

name: Sync Reference Lockfile

on:
  push:
    branches: [main]
    paths:
      - "reference/requirements.txt"

defaults:
  run:
    shell: bash

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-lockfile:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-environment

      - uses: ./.github/actions/generate-variant
        id: generate
        with:
          variant-name: full
          clean: "true"

      - name: Apply dependency updates
        working-directory: ${{ steps.generate.outputs.project-path }}
        run: |
          while read -r line; do
            pkg=$(echo "${line}" | cut -d'=' -f1)
            ver=$(echo "${line}" | grep -oP '==\K[0-9a-zA-Z.]+')
            if [[ -n "${pkg}" && -n "${ver}" ]]; then
              echo "Updating ${pkg} to ${ver}"
              uv add "${pkg}==${ver}" || echo "Warning: failed to add ${pkg}==${ver}"
            fi
          done < <(git -C ../.. diff HEAD~1 HEAD -- reference/requirements.txt | grep '^+[^+]' | sed 's/^+//')

      - name: Copy lockfile to template
        run: |
          template_lockfile="{{cookiecutter.project_name}}/{% if cookiecutter.include_uv_lock -%} uv.lock {%- endif %}"
          cp ${{ steps.generate.outputs.project-path }}/uv.lock "${template_lockfile}"

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet; then
            echo "changes=false" >> "${GITHUB_OUTPUT}"
          else
            echo "changes=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Create pull request
        if: steps.check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: chore/sync-template-lockfile
          delete-branch: true
          labels: |
            dependencies
            automated
          commit-message: "chore(deps): sync template lockfile from reference"
          title: "chore(deps): sync template lockfile from reference"
          body: |
            Syncs the updated `uv.lock` from `reference/` to the cookiecutter template.

            This PR was automatically created after a dependency update was merged.
