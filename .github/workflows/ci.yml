name: CI

on:
  push:
    branches: [main]

defaults:
  run:
    shell: bash

jobs:
  load-variants:
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      names: ${{ steps.set-matrix.outputs.names }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          echo "matrix=$(jq -c '.variants' variants.json)" >> "${GITHUB_OUTPUT}"
          echo "names=$(jq -c '[.variants[].name]' variants.json)" >> "${GITHUB_OUTPUT}"

  generate-and-install:
    needs: load-variants
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.load-variants.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v4

      - name: Install cookiecutter
        run: pipx install cookiecutter

      - name: Restore uv cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ matrix.name }}-${{ hashFiles('variants.json') }}
          restore-keys: |
            uv-${{ matrix.name }}-

      - name: Generate project
        env:
          VARIANT_NAME: ${{ matrix.name }}
          SENTRY: ${{ matrix.sentry }}
          ASYNC: ${{ matrix.async }}
          CLI: ${{ matrix.cli }}
          WEB: ${{ matrix.web }}
          API: ${{ matrix.api }}
          API_AUTH: ${{ matrix.api_auth }}
          API_LAMBDA: ${{ matrix.api_lambda }}
          API_LAMBDA_TRACING: ${{ matrix.api_lambda_tracing }}
          API_LAMBDA_METRICS: ${{ matrix.api_lambda_metrics }}
          API_PAGINATION: ${{ matrix.api_pagination }}
          API_VERSIONING: ${{ matrix.api_versioning }}
        run: |
          ./scripts/generate.bash \
            --name "test-${VARIANT_NAME}" \
            --sentry "${SENTRY}" \
            --async "${ASYNC}" \
            --cli "${CLI}" \
            --web "${WEB}" \
            --api "${API}" \
            --api-auth "${API_AUTH}" \
            --api-lambda "${API_LAMBDA}" \
            --api-lambda-tracing "${API_LAMBDA_TRACING}" \
            --api-lambda-metrics "${API_LAMBDA_METRICS}" \
            --api-pagination "${API_PAGINATION}" \
            --api-versioning "${API_VERSIONING}" \
            --docker "true" \
            --pycharm "false"

      - name: Install dependencies
        run: ./scripts/install.bash ".test-output/test-${{ matrix.name }}"

      - name: Upload project artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-${{ matrix.name }}
          path: .test-output/test-${{ matrix.name }}
          retention-days: 1

  lint:
    needs: [load-variants, generate-and-install]
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        variant: ${{ fromJSON(needs.load-variants.outputs.names) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v4

      - name: Restore uv cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ matrix.variant }}-${{ hashFiles('variants.json') }}
          restore-keys: |
            uv-${{ matrix.variant }}-

      - name: Download project artifact
        uses: actions/download-artifact@v4
        with:
          name: project-${{ matrix.variant }}
          path: .test-output/test-${{ matrix.variant }}

      - name: Install dependencies
        run: ./scripts/install.bash ".test-output/test-${{ matrix.variant }}"

      - name: Run lint
        run: ./scripts/lint.bash ".test-output/test-${{ matrix.variant }}"

  test:
    needs: [load-variants, generate-and-install]
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        variant: ${{ fromJSON(needs.load-variants.outputs.names) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v4

      - name: Restore uv cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ matrix.variant }}-${{ hashFiles('variants.json') }}
          restore-keys: |
            uv-${{ matrix.variant }}-

      - name: Download project artifact
        uses: actions/download-artifact@v4
        with:
          name: project-${{ matrix.variant }}
          path: .test-output/test-${{ matrix.variant }}

      - name: Install dependencies
        run: ./scripts/install.bash ".test-output/test-${{ matrix.variant }}"

      - name: Run tests
        run: ./scripts/test.bash ".test-output/test-${{ matrix.variant }}"

  summary:
    needs: [load-variants, lint, test]
    if: always()
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    steps:
      - name: Generate summary
        env:
          VARIANTS: ${{ needs.load-variants.outputs.names }}
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
        run: |
          echo "## CI Summary" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"

          if [[ "${LINT_RESULT}" == "success" && "${TEST_RESULT}" == "success" ]]; then
            echo "### All checks passed" >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "### Some checks failed" >> "${GITHUB_STEP_SUMMARY}"
          fi

          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Job | Status |" >> "${GITHUB_STEP_SUMMARY}"
          echo "|-----|--------|" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Lint | ${LINT_RESULT} |" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Test | ${TEST_RESULT} |" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"

          echo "### Variants tested" >> "${GITHUB_STEP_SUMMARY}"
          echo '```json' >> "${GITHUB_STEP_SUMMARY}"
          echo "${VARIANTS}" | jq '.' >> "${GITHUB_STEP_SUMMARY}"
          echo '```' >> "${GITHUB_STEP_SUMMARY}"

      - name: Fail if any check failed
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
        run: |
          if [[ "${LINT_RESULT}" != "success" || "${TEST_RESULT}" != "success" ]]; then
            echo "Some checks failed: lint=${LINT_RESULT}, test=${TEST_RESULT}"
            exit 1
          fi
